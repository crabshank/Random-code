<html>

<head>
<style>
input[type="file" i]::-webkit-file-upload-button  {
    background: buttonface;
}
</style>
</head>

<body>
	<h1 id="ttl" style="text-align: center;">File contents as .js string</h1>
    <div class="file1">
	 <input type="file" id="openFile1"><br><br>
<section id="js_setup" style="margin-top: -0.6em;">
<section id="js_setup_b" style="display: flex;place-items: flex-start;">
<select id="sel" style="border-width: 0px;">
<option>const</option>
<option>let</option>
<option>var</option>
</select>
<input type="text" id="str_nm" style="border-width: 0px;width: 30%;margin-left: 0.17%;margin-right: 0.25%;">
<textarea id="txt1" style="width: 64%; margin-left: 0.02%;"></textarea><br>
</section>
<section id="js_setup_c" style=" display: inline-flex; position: absolute; top: 16.7%;">
<button id="svb" style="display: none;">
<a id="sva" style="text-decoration: none; color: black;">Save .js file</a>
</button>
<section id="lbl" style="transform-origin:left center;">
<label for="dt_chk">Include todays date in output file's name?</label>
<input type="checkbox" id="dt_chk"style="margin-left: -0.52%;">
</section>
</section><br>
</section>
</section>
</div>     

<br>

 <script>

var nos1=document.getElementById("txt1");
var nm=document.getElementById("str_nm");
var svrb=document.getElementById("svb");
var svra=document.getElementById("sva");
var sl=document.getElementById("sel");
var dtChk=document.getElementById("dt_chk");
var jssc=document.getElementById("js_setup_c");
var labl=document.getElementById("lbl");

function getAdjCurrDateTimeOffset(outISO,ignoreTimeZones,offst){
	offst=(typeof offst==='undefined')?0:offst;
	let now = new Date();
    let tz_offset = (typeof ignoreTimeZones==='undefined' || !ignoreTimeZones)?now.getTimezoneOffset() * 60000:0	;
	let t=now.getTime()- tz_offset + offst;
	if(outISO){
		return new Date(t).toISOString();
	}else{
		return t;
	}
}

function escaper(s){
let terms=['`','${'];
let outs=[];
for(let k=0, len=terms.length; k<len; k++){
	var ix=s.indexOf(terms[k]);
	var i = [];
	if(ix>=0){
		i.push([ix,ix+terms[k].length-1]);
		let end=false;
		while(!end){
			ix=s.indexOf(terms[k], (i[i.length-1][0] + 1));
			if(ix>=0){
				i.push([ix,ix+terms[k].length-1]);
			}else{
				end=true;
			}
		}
	}
	outs.push(i);
}
	let outs_f=[];
	let ss=[...s];
	for(let k=0, len0=outs.length; k<len0; k++){
		for(let j=0, len1=outs[k].length; j<len1; j++){
			let x=outs[k][j][0];
			if(x==0 || !ss[x-1].endsWith('\\')){
				outs_f.push(x);
			}
		}
	}
	for(let k=0, len=outs_f.length; k<len; k++){
		ss[outs_f[k]]='\\'+ss[outs_f[k]];
	}
	return ss.join('');
}

nos1.oninput=()=>{
		nos1.style.height='min-content';
		nos1.style.height=nos1.scrollHeight+3;
};

svra.onclick=()=>{
		let str=nos1.value;
		nos1.value = str;
		str=sl.value+' '+nm.value+'='+str;
		svra.setAttribute('href', 'data:text/javascript;charset=utf-8,' + encodeURIComponent(str));
		svra.setAttribute('download', (dtChk.checked)?nm.getAttribute('file_name_d'):nm.getAttribute('file_name'));
};

function alignBtns(){
document.body.scrollTop = 0;
let b=Math.max(nm.offsetTop+nm.clientHeight, sl.offsetTop+sl.clientHeight);
jssc.style.top=(b+4)+'px';
}

alignBtns();
rsz(false);

function rsz(forceShowBtn){
	nos1.style.height='min-content';
	nos1.style.height=nos1.scrollHeight+3;
	if(forceShowBtn){
		svrb.style.cssText='display: initial;';	
	}
	document.body.scrollTop=0;
	document.body.scrollLeft=0;
	labl.style.cssText='transform-origin:left center;';			
	let bRct=svrb.getBoundingClientRect();
	let txRct=nos1.getBoundingClientRect();
	let lbRct=lbl.getBoundingClientRect();
	let w=txRct.left-bRct.right;
	labl.style.cssText='transform-origin:left center; transform: scale('+((w-3)/lbRct.width)+')'+((forceShowBtn)?' translateX(3px);':';');			
}
 document.getElementById("openFile1").addEventListener('change',  function () {
	 var fr = new FileReader();
	 fr.onload = function () {
		let str = this.result;
		str='`'+(escaper(str))+'`;';
		nos1.value = str;
		rsz(true);
	}
	
	let todate_f=getAdjCurrDateTimeOffset(true).split('T')[0].split('-').join('_');
		
	let n=this.files[0].name.split('.')[0];
	nm.value=n;
	nm.setAttribute('file_name',n);
	nm.setAttribute('file_name_d',n+'_'+todate_f);
	fr.readAsText(this.files[0]);
});

</script>
</body>

</html>