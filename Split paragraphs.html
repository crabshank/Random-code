<html>
<head>
<meta charset="UTF-8">
</head>
<body>
<title>Split paragraphs</title>
<style>
div > section:hover {
border-right: 0.34ch dotted transparent;
background-color: hsl(46deg 90% 28%);
}

div > section {
display: inline-block;
width: 100%;
color: white;
}
body, textarea {
background-color: hsl(0 0% 8% / 1);
}
</style>
<h1 style="text-align: center; margin-bottom: 1.1%;">Split text</h1>
<input type="checkbox" style="margin-left: 50%;">Split by word (space)</input><br>
<label for="quotes" style="margin-left: 50%;">Select quotation mark type: </label><select id="quotes" style="color: black; background-color: buttonface;"></select>
<main style="display: flex;">
<textarea style="box-shadow: 0 0 0px 1px black; border-width: 0px; width:50%;"></textarea>
<div style="float:right; margin-inline-start: 4px;  width:50%;"></div>
</main>
<script>
var last='';
var p_cnt=1;

function resize(el,ceil){
el.style.maxWidth=(ceil==1)?Math.ceil(document.body.offsetWidth*0.5):Math.floor(document.body.offsetWidth*0.5);
el.style.height=Math.max(window.innerHeight,el.scrollHeight);

document.body.onresize=function(){
el.style.maxWidth=(ceil==1)?Math.ceil(document.body.offsetWidth*0.5):Math.floor(document.body.offsetWidth*0.5);
}
}

var pSpl='';
var wrdSpl='';
var c_pSpl='';
var c_wrdSpl='';

wdSpl=document.getElementsByTagName("input")[0];
slq=document.getElementById("quotes");
  var marks = [[],['"','"'],['“','”'],["‘", "’"],["’","’"],["‚","’"]	,['„','“'],['«','»'],['»','«'],['《','》'],['‹','›'],['›','‹'],['「','」'],['『','』']];

  // Loop through voices and create an option for each one
  marks.forEach(mark => {
    // Create option element
    let opt = document.createElement('option');
	opt.style.cssText='color: black;';
    opt.textContent = mark.join('…');

    slq.appendChild(opt);
  });


ebd=document.getElementsByTagName("textarea")[0];
dv=document.getElementsByTagName("div")[0];
var gFontSize=window.getComputedStyle(dv, null).getPropertyValue('font-size');
ebd.style.fontSize=gFontSize;

resize(ebd,0);
resize(dv,1);

dv.oninput=function () {
dv.style.height = 'inherit';
dv.style.height = (dv.scrollHeight+2)+"px";
}
function retain_spl_arr(s,c){
var sa= s.split(c);
for (let i= sa.length; i-->1;){
    sa.splice(i, 0, c);
}
var sb=[];
for (let k= 0; k < sa.length; k++){
if(sa[k]!=''){
sb.push(sa[k]);
}
}
return sb;
}

function attached_chars(c,str,n,f){
let ln='';


	for (let i = 0; i < n; i++){
	ln+='<br>';
	}


var spl=retain_spl_arr(str,' ');

if (!f){
	for (let i=spl.length-2; i>0; i--){
	if((spl[i]==' ')&&(spl[i+1].includes(c))){
	spl[i+1]=ln+spl[i+1];
	}
	}

	if(spl[0].includes(c)){
	let ln='';
		for (let i = 0; i < n-1; i++){
		ln+='<br>';
		}
	spl[0]=ln+spl[0];
	}
}else{
	for (let i=1; i<spl.length-1; i++){
	if((spl[i]==' ')&&(spl[i-1].includes(c))){
	spl[i-1]+=ln;
	}
	}

	let t=spl.length-1;

	if(spl[t].includes(c)){
	let ln='';
		for (let i = 0; i < n-1; i++){
		ln+='<br>';
		}
	spl[t]+=ln;
	}
}


return spl.join('');
}


function add_rpt(str,sbs,n){
 
  var spl=retain_spl_arr(str,sbs);
  var occ=[];
  
  for (let i = 0; i < spl.length; i++){
    if(spl[i]==sbs){
      occ.push(i);
    }
  }
  
  var run = 1;
  var rem=[];
  
for (let k= 0; k < occ.length-1; k++){
  if(occ[k+1]==occ[k]+1){
    run++;
	if (k==occ.length-2){rem.push([occ[k+1],run]);}
  }else{
	rem.push([occ[k],run]);
	if (k==occ.length-2){rem.push([occ[k+1],1]);}
	run=1;
}
}


var exempt=[];
var outp=[];

for (let i= 0; i < rem.length; i++){
  if(n<0){
    let m=Math.min(Math.abs(n),rem[i][1]);
    for (let k=0; k<m;k++){
      if(rem[i][0]-k>=0){
        exempt.push(rem[i][0]-k);
      }
    }
  }else{
   let ln='';
for (let p = 0; p<n; p++){
ln+=sbs;
}
spl[rem[i][0]]+=ln;
  }
}

if (n<0){
  for (let i= 0; i < spl.length; i++){
    if(!(exempt.includes(i))){
      outp.push(spl[i]);
    }
  }
  return outp.join('');
}else{
  return spl.join('');
}

}

function changer(){
ebd.style.height = 'inherit';
ebd.style.height = (dv.scrollHeight+2)+"px";
dv.innerHTML=ebd.value;
p_cnt=1;
if(ebd.value!=''){
let itd=retain_spl_arr(ebd.value.trim(),'\n');
for (let k= 0; k < itd.length; k++){
if (itd[k]=='\n'){
itd[k]='<br>';
}
}
pSpl='¶{'+p_cnt+'}<br>';
p_cnt++;


function brk(ln){
	ln=attached_chars('.',ln,2,true);
	ln=attached_chars('。',ln,2,true);
	ln=attached_chars('︒',ln,2,true);
	ln=attached_chars('?',ln,2,true);
	ln=attached_chars('؟',ln,2,true);
	ln=attached_chars('‽',ln,2,true);
	ln=attached_chars('？',ln,2,true);
	ln=attached_chars('¡',ln,2,false);
	ln=attached_chars('¿',ln,2,false);
	ln=attached_chars('⸘',ln,2,false);
	ln=attached_chars('՞',ln,2,true);
	ln=attached_chars('!',ln,2,true);
	ln=attached_chars('~',ln,2,true);
	ln=attached_chars('！',ln,2,true);
	ln=attached_chars(':',ln,1,true);
	ln=attached_chars('：',ln,1,true);
	ln=attached_chars(';',ln,1,true);
	ln=attached_chars('；',ln,1,true);
	ln=attached_chars('·',ln,1,true);
	ln=attached_chars('჻',ln,1,true);
	ln=attached_chars(',',ln,1,true);
	ln=attached_chars('，',ln,1,true);
	ln=attached_chars('、',ln,1,true);
	ln=attached_chars('،',ln,1,true);
	return ln;
}

for (let k = 0; k < itd.length; k++) {		
	if(k<itd.length-1){
	if ((itd[k]=='<br>')&&(itd[k+1]=='<br>')){
	itd[k]='<br>⁋<br><br>¶{'+p_cnt+'}';
	p_cnt++;
	}else{
	itd[k]=brk(itd[k]);
	}
	}else{
	itd[k]=brk(itd[k]);		
	}
}

pSpl+=itd.join('');
pSpl+='<br>⁋';

pSpl=pSpl.split('<br><br><br>⁋').join('<br>⁋');
pSpl=pSpl.split('<br><br>⁋').join('<br>⁋');

let pSpl_arr=retain_spl_arr(pSpl,'<br>');

for (let k = 0; k <pSpl_arr.length ; k++) {
	if ((pSpl_arr[k]!='<br>')&&(!((pSpl_arr[k].startsWith('¶{'))&&(pSpl_arr[k].endsWith('}'))))&&(pSpl_arr[k]!='⁋')){
	pSpl_arr[k]='<section>'+pSpl_arr[k].trim()+'</section>';
	}
}
pSpl=pSpl_arr.join('');

wrdSpl=pSpl.split('<section>').join('');
wrdSpl=wrdSpl.split('</section>').join('');

wrdSpl=add_rpt(wrdSpl,'<br>',1);
wrdSpl=wrdSpl.split(' ').join('<br>');
for (let k = 1; k <=p_cnt ; k++) {	
wrdSpl=wrdSpl.split('¶{'+k+'}<br><br>').join('¶{'+k+'}<br>');
}
wrdSpl=wrdSpl.split('<br><br>⁋').join('<br>⁋');
wrdSpl=wrdSpl.split('⁋<br><br><br><br>¶{').join('⁋<br><br><br>¶{');
let wrdSpl_arr=retain_spl_arr(wrdSpl,'<br>');

for (let k = 0; k <wrdSpl_arr.length ; k++) {
	if ((wrdSpl_arr[k]!='<br>')&&(!((wrdSpl_arr[k].startsWith('¶{'))&&(wrdSpl_arr[k].endsWith('}'))))&&(wrdSpl_arr[k]!='⁋')){
	wrdSpl_arr[k]='<section>'+wrdSpl_arr[k]+'</section>';
	}
}
wrdSpl=wrdSpl_arr.join('');
dv.innerHTML=(!wdSpl.checked)?pSpl:wrdSpl;
}else{
dv.innerHTML='';
}
last=ebd.value;
dv.style.fontSize=(!wdSpl.checked)?gFontSize:"194%";


  
  let op=[...slq.getElementsByTagName('OPTION')];
  
  for (let k = 1; k <op.length ; k++) {
    op[k].textContent =marks[k].join('…')+ ' ('+((ebd.value.split(marks[k][0]).length-1)+((ebd.value.split(marks[k][1]).length-1)))+')';
  }

if(!wdSpl.checked){
cenSpeech(pSpl,0);
}else{
cenSpeech(wrdSpl,1);
}

}


function cenSpeech(spl,pw){
if (slq.selectedIndex!=0){
dv.innerHTML='';
let opn=marks[slq.selectedIndex][0];
let cls=marks[slq.selectedIndex][1];

let opns=retain_spl_arr(spl,opn);
let splt=[];

for (let k =0; k< opns.length; k++) {
if (opns[k]!=opn){
let s=retain_spl_arr(opns[k],cls);
for (let l =0; l< s.length; l++) {
splt.push(s[l]);
}
}else{
splt.push(opns[k]);
}
}


for (let k =0; k<splt.length; k++) {
if (splt[k]==opn){
if (k>0){
let b=retain_spl_arr(splt[k-1],'<section>');
for (let j=b.length-1; j>=0; j--) {
if(b[j]=='<section>'){
b[j]='<section class="quote" style="text-align: center;">';
j=0;
}
}
splt[k-1]=b.join('');
}

if (splt[k+2]==cls){
splt[k+1]=splt[k+1].split('<section>').join('<section class="quote" style="text-align: center;">');
k++;
}
}
}

console.log(splt);

if(pw==1){
c_wrdSplSpl=splt.join('');
dv.innerHTML=c_wrdSplSpl;
}else{
c_pSpl=splt.join('');
dv.innerHTML=c_pSpl;
}

}else{
dv.innerHTML=spl;
}

}

slq.onchange=function(){
slq.blur(); 
if(!wdSpl.checked){
cenSpeech(pSpl,0);
}else{
cenSpeech(wrdSpl,1);
}
}
ebd.oninput=function(){
changer();
}
ebd.onchange=function(){
if(last!=ebd.value){
changer();
}
}

wdSpl.oninput=function(){
dv.style.fontSize=(!wdSpl.checked)?gFontSize:"194%";
if(!wdSpl.checked){
dv.innerHTML=pSpl;
cenSpeech(pSpl,0);
}else{
dv.innerHTML=wrdSpl;
cenSpeech(wrdSpl,1);
}
}

</script>
</body>
</html>